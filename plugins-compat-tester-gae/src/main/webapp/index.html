<!DOCTYPE html>
<html>
  <head>
      <title>Plugin compatibility tester</title>

      <link rel="stylesheet" type="text/css" href="./css/chosen/chosen-0.9.5.css" />
      <link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.4.0/bootstrap.min.css">
      <style type="text/css">
.input .input-list li {
    padding-bottom: 10px;
}
div.input ul li label span {
    line-height: 20px;
    vertical-align: top;
}
.chzn-container-multi .chzn-choices .search-choice {
    width: auto;
    height: 18px;
    background-color: #0064cd;
    background-image: -webkit-linear-gradient(top, rgb(4, 156, 219), rgb(0, 100, 205));
    -webkit-box-shadow: rgba(255, 255, 255, 0.199219) 0px 1px 0px 0px inset, rgba(0, 0, 0, 0.046875) 0px 1px 2px 0px;
    box-shadow: rgba(255, 255, 255, 0.199219) 0px 1px 0px 0px inset, rgba(0, 0, 0, 0.046875) 0px 1px 2px 0px;
    color: white;
}
fieldset {
    background-color: whitesmoke;
    padding-top: 8px;

    -webkit-border-radius: 6px;
    -moz-border-radius   : 6px;
    border-radius        : 6px;
    -moz-background-clip   : padding;
    -webkit-background-clip: padding-box;
    background-clip        : padding-box;
}
.spinner {
    background-image: url("/img/pct/spinner.gif");
}

fieldset legend {
    padding-left: 30px;
}
      </style>

      <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
      <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
      <script type="text/javascript" src="./js/chosen/chosen.jquery-0.9.5.min.js"></script>
      <script type="text/javascript" src="./js/json/json2.js"></script>
      <script type="text/javascript" src="./js/utils/ajax-utils.js"></script>
      <script type="text/javascript">
function ajaxSubmitForm(form){
    $("#searchSpinner").show();
    $.getJSON("/getResults", $(form).serializeObject(), function(pctReport){
        $("#searchSpinner").hide();

        var numberOfJenkinsColumns = 0;
        var numberOfHudsonColumns = 0;
        $.each(pctReport.coreCoordinates, function(){
            numberOfJenkinsColumns += this.g==="org.jenkins-ci.plugins"?1:0;
            numberOfHudsonColumns += this.g==="org.jenkins-ci.plugins"?0:1;
        });
        $.tmpl("resultsTpl", {
            numberOfJenkinsColumns: numberOfJenkinsColumns,
            numberOfHudsonColumns: numberOfHudsonColumns,
            coreCoordinates: pctReport.coreCoordinates
        }).appendTo("#results");

        var previousPluginName = "";
        $.each(pctReport.results, function(pctResultsIndex){
            var pluginResult = this;
            var pluginName = pluginResult.plugin.split(":")[0];
            var pluginVersion = pluginResult.plugin.split(":")[1];
            var cellResults = [];
            var currentPluginReportResultIndex = 0;
            $.each(pctReport.coreCoordinates, function(){
                var gav = this.g+":"+this.a+":"+this.v;
                if(pluginResult.results && currentPluginReportResultIndex < pluginResult.results.length
                        && gav===pluginResult.results[currentPluginReportResultIndex].core){
                    cellResults.push($.extend(pluginResult.results[currentPluginReportResultIndex], { empty: false }));
                    currentPluginReportResultIndex++;
                } else {
                    cellResults.push({ empty: true });
                }
            });

            var tmplParams = {
                pluginName: pluginName,
                pluginVersion: pluginVersion,
                results: cellResults
            };

            if(previousPluginName === pluginName){
                $("#resultOtherPluginLineTpl").tmpl(tmplParams).appendTo("#results #resultBody");
            } else {
                // Counting next results having the same plugin name
                var i = pctResultsIndex+1;
                while(i < pctReport.results.length &&
                        pluginName === pctReport.results[i].plugin.split(":")[0]){
                    i++;
                }

                $("#resultFirstPluginLineTpl").tmpl($.extend(tmplParams, {
                    pluginResultsCount: i - pctResultsIndex
                })).appendTo("#results #resultBody");
            }

            previousPluginName = pluginName;
        });
    });
}

$(function(){
    $("#searchForm").submit(function(){ ajaxSubmitForm(this); return false; });
    $("#cores").chosen();
    $("#plugins").chosen();
    $.getJSON("/getData?type=cores", function(results){
        $("#cores").empty();
        $.each(results.cores, function(){
            $("<option value=\""+this.g+":"+this.a+":"+this.v+"\">"+(this.g=="org.jenkins-ci.plugins"?"Jenkins":"Hudson")+" v"+this.v+"</option>").appendTo($("#cores"));
        });
        $("#cores").trigger("liszt:updated");
    });
    $.getJSON("/getData?type=pluginInfos", function(results){
        $("#plugins").empty();
        $.each(results.pluginInfos, function(){
            $("<option value=\""+this+"\">"+this+"</option>").appendTo($("#plugins"));
        });
        $("#plugins").trigger("liszt:updated");
    });
    $("#resultsTpl").template("resultsTpl");
});
      </script>
  </head>
  <body>
    <div class="container">
        <form id="searchForm" action="/getResults" method="post">
            <fieldset>
                <legend>Plugin compatibility search criteria</legend>
                <label for="plugins">Target parent cores :</label>
                <div class="input">
                    <ul class="inputs-list">
                        <li>
                            <label>
                                <input type="radio" id="everyCores" name="everyCores" value="true" />
                                <span>Every plugins</span>
                            </label>
                        </li>
                        <li>
                            <label>
                                <input type="radio" id="selectedCores" name="everyCores" value="false" checked/>
                                <span>Selected cores :</span>
                                <select id="cores" name="cores" class="chzn-select" style="width: 635px" multiple>
                                </select>
                            </label>
                        </li>
                    </ul>
                </div>
                <label for="plugins">Target plugins :</label>
                <div class="input">
                    <ul class="inputs-list">
                        <li>
                            <label>
                                <input type="radio" id="everyPlugins" name="everyPlugins" value="true" />
                                <span>Every plugins</span>
                            </label>
                        </li>
                        <li style="padding-bottom: 10px">
                            <label>
                                <input type="radio" id="selectedPlugins" name="everyPlugins" value="false" checked/>
                                <span>Selected plugins :</span>
                                <select id="plugins" name="plugins" class="chzn-select" style="width: 635px" multiple>
                                </select>
                            </label>
                        </li>
                    </ul>
                </div>
            </fieldset>
            <input type="submit" class="btn primary" value="Search" />
            <img height="28" id="searchSpinner" class="spinner" src="img/pct/spinner.gif" alt="Spinner" style="vertical-align: middle; display: none" />
        </form>
        <div id="results">
            <script id="resultCellContentTpl" type="text/x-jquery-tmpl">
                {{if empty}}
                <td>-----</td>
                {{else}}
                <td>${status}</td>
                {{/if}}
            </script>
            <script id="resultFirstPluginLineTpl" type="text/x-jquery-tmpl">
                <tr>
                    <td rowspan="${pluginResultsCount}" style="vertical-align: middle">${pluginName}</td>
                    <td>${pluginVersion}</td>
                    {{tmpl(results) "#resultCellContentTpl"}}
                </tr>
            </script>
            <script id="resultOtherPluginLineTpl" type="text/x-jquery-tmpl">
                <tr>
                    <td>${pluginVersion}</td>
                    {{tmpl(results) "#resultCellContentTpl"}}
                </tr>
            </script>
            <script id="resultsHeadingTpl" type="text/x-jquery-tmpl">
                <th style="text-align: center">${v}</th>
            </script>
            <script id="resultsTpl" type="text/x-jquery-tmpl">
                <table class="condensed-table bordered-table">
                    <thead id="resultHeading">
                        <tr>
                            <th rowspan="2" colspan="2">Plugin name & version</th>
                            {{if numberOfJenkinsColumns > 0}}
                            <th colspan="${numberOfJenkinsColumns}" style="text-align: center">Jenkins</th>
                            {{/if}}
                            {{if numberOfHudsonColumns > 0}}
                            <th colspan="${numberOfHudsonColumns}" style="text-align: center">Hudson</th>
                            {{/if}}
                        </tr>
                        <tr>
                            {{tmpl(coreCoordinates) "#resultsHeadingTpl"}}
                        </tr>
                    </thead>
                    <tbody id="resultBody">
                    </tbody>
                </table>
            </script>
        </div>
    </div>
  </body>
</html>